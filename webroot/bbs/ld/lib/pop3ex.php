<?php  class Pop_Item{var $prop;var $attaches =array();function set($name,$value){$this->prop[$name] =$value;}function get($name){return $this->prop[$name];}function addattach($name,$content){$this->attaches[$name] =$content;}function attach_count(){return count($this->attaches);}}class pop3ex extends pop3{var $mails =array();var $cachefile ="data/mailcache";var $timewait =60;function can_execute(){if(file_exists($this->cachefile)){$bet =time()- filemtime($this->cachefile);if($bet < $this->timewait){return FALSE;}else{unlink($this->cachefile);return FALSE;}}else{$fp =fopen($this->cachefile,"w");fclose($fp);return TRUE;}}function get_mails(){return $this->mails;}function get_ids(){static $ids;if(!empty($ids))return $ids;$ar =array_keys($this->get_list());if(is_array($ar)){$ids =$ar;return $ar;}else{return array($ar);}}function delete_all(){$ids =$this->get_ids();foreach($ids as $id){$this->dele($id);}}function get_messages(){$ids =$this->get_ids();$mess_ar =array();foreach($ids as $id){$message =$this->retr($id);if($message =="")continue;list($head,$body)=split("\r\n\r\n",$message,2);$mail =new Pop_Item;preg_match("/From:(.+?)\r\n/",$head,$reg);$mail->set("from",$reg[1]);preg_match("/Subject:(.+?)\r\n/",$head,$reg);if(preg_match("/.*?=\?iso-2022-jp\?B\?([^\?]+)\?=/i",$reg[1],$reg2)){$subject =base64_decode($reg2[1]);}else if(preg_match("/.*?=\?iso-2022-jp\?Q\?([^\?]+)\?=/i",$reg[1],$reg2)){$subject =quoted_printable_decode($reg2[1]);}else{$subject =$reg[1];}if($subject ==""){$subject ="ÌµÂê";}$mail->set("subject",$subject);if(preg_match("/\nContent-type:.*multipart\//i",$head)){preg_match("/boundary=\"([^\"]+)\"/",$head,$reg);$boundary ="--".$reg[1];$items =split($boundary,$body);for($i=0;$i<count($items);$i++){$row =$items[$i];list($head1,$body1)=split("\r\n\r\n",$row);preg_match("/name=\"([^\"]+)\"/",$head1,$reg);$filename =trim($reg[1]);$b64 =preg_match("/Content-Transfer-Encoding:.*base64/",$head1);$qpt =preg_match("/Content-Transfer-Encoding:.*quoted-printable/", $head1);if($b64){$body1 =trim($body1);$body1 =preg_replace("/\r|\n/","",$body1);if($filename !=""){$file =base64_decode($body1);$mail->addattach($filename,$file);}else {if(trim($body1)!="")$mail->set("body",trim(base64_decode($body1)));}}elseif($qpt){$body1 =trim($body1);$body1 =preg_replace("/\r|\n/","",$body1);if($filename !=""){$file =quoted_printable_decode($body1);$mail->addattach($filename,$file);}else {if(trim($body1)!="")$mail->set("body",trim(quoted_printable_decode($body1)));}}else{if(trim($body1)!="")$mail->set("body",trim($body1));}}}else{$b64 =preg_match("/Content-Transfer-Encoding:.*base64/",$head);$qpt =preg_match("/Content-Transfer-Encoding:.*quoted-printable/", $head);if($b64){if(trim($body)!="")$mail->set("body",trim(base64_decode($body1)));}elseif($qpt){if(trim($body)!="")$mail->set("body",trim(quoted_printable_decode($body)));}else{if(trim($body)!="")$mail->set("body",trim($body));}}array_push($this->mails,$mail);}}}?>